{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>EduMart | {% block title %}{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'store/auth.css' %}">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <style>
        .card-img-top { height: 200px; object-fit: contain; padding: 10px; }
        .cart-row { display: flex; align-items: center; justify-content: space-between; }
        .quantity-controls img { width: 20px; cursor: pointer; margin: 0 5px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid container">
        <a class="navbar-brand" href="{% url 'store' %}">EduMart</a>
        <div class="d-flex">
            {% if user.is_authenticated %}
                <span class="navbar-text me-3 text-light">Welcome, {{ user.username }}!</span>
                <a href="{% url 'order_history' %}" class="btn btn-outline-info me-2">My Orders</a>
                
                {# CORRECT: Logout uses a POST form for security #}
                <form action="{% url 'logout' %}" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-danger me-2">Logout</button>
                </form>
            {% else %}
                <a href="{% url 'login' %}" class="btn btn-outline-success me-2">Login</a>
                <a href="{% url 'register' %}" class="btn btn-outline-light me-2">Register</a> 
            {% endif %}
            
            <a href="{% url 'cart' %}" class="btn btn-warning position-relative">
                ðŸ›’ Cart 
                <span id="cart-total" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                    {{ cartItems }}
                </span>
            </a>
        </div>
      </div>
    </nav>
    <div class="container mt-4">
        {% block content %}
        {% endblock content %}
    </div>

    <script type="text/javascript">
        // Global variable for JavaScript to access
        var user = '{{request.user}}';

        // Fetch CSRF token for secure POST requests
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        // Function to send cart updates to the backend
        function updateUserOrder(productId, action){
            console.log('User is logged in, sending data...');

            var url = '{% url "update_item" %}';

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken, // Include CSRF token
                },
                body: JSON.stringify({'productId': productId, 'action': action})
            })
            .then(response => response.json())
            .then(data => {
                console.log('Data:', data);
                // Update the cart total badge in the navbar
                document.getElementById('cart-total').innerHTML = data.cartItems;
                
                // If on cart page, refresh to show new totals/items
                if (window.location.pathname.includes('/cart/')) {
                    window.location.reload();
                }
            })
            .catch((error) => {
                console.error('Error updating item:', error);
                alert('An error occurred while updating the cart.');
            });
        }
        
        // Event listener for all "Add to Cart" and quantity control buttons
        var updateBtns = document.getElementsByClassName('update-cart');
        for (i = 0; i < updateBtns.length; i++) {
            updateBtns[i].addEventListener('click', function(){
                var productId = this.dataset.product;
                var action = this.dataset.action;
                
                if (user == 'AnonymousUser'){
                    // If not logged in, you should redirect the user to the login page
                    alert('Please login to use the cart.');
                    // window.location.href = '{% url "login" %}'; // Recommended action
                    return; 
                }

                updateUserOrder(productId, action);
            });
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>